---
title: "Getting Started with the `mpcmp` package (under construction)"
author: "Thomas Fung, Aya Alwan, Justin Wishart and Alan Huang"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: library.bib
fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Getting Started with the `mpcmp` package (under construction)}
  %\usepackage[utf8]{inputenc}
  %\VignetteEngine{knitr::knitr}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
## Introduction {#intro}

Conway–Maxwell–Poisson (CMP or COM-Poisson) distributions have seen a recent resurgence in popularity for the analysis of dispersed counts (e.g., @Shmueli2005; @Lord2008, -@Lord2010; @Sellers2010). Key features of COM-Poisson distributions include the ability to handle both overdispersion and underdispersion, containing the classical Poisson distribution as a special case, and being a continuous bridge between other classical distributions such as the geometric and Bernoulli distributions. See @Shmueli2005 for a more detailed overview of the history, features and applications of CMP distributions.

The R (@R-base) `mpcmp` package (@R-mpcmp) provides functionality for
estimating a mean-parametrized Conway-Maxwell-Poisson generalzied linear models for dispersed count data. The package is available from the Comprehensive R Archive Network (CRAN) [here](http://CRAN.R-project.org/package=mpcmp). @Huang2017b provides the theoretical development of the model that this package bases on. 

## Conway-Maxwell-Poisson Distributions {#cmpintro}
The CMP distribution was first used by @Conway1962 as a model for queuing system with dependent service times. A random variable is said to have a (standard) CMP distribution with rate parameter $\lambda$ and dispersion parameter $\nu$ if its probability mass function (pmf) is given by
$$
P(Y =y|λ,ν)= \frac{\lambda^y}{(y!)^{\nu}}\frac{1}{Z(\lambda,\nu)}, \quad y =0,1,2,...,
$$ 
where
$$
Z(\lambda,\nu)= \sum^{\infty}_{y=0}\frac{\lambda^y}{(y!)^{\nu}},
$$
is a normalizing constant. The CMP includes Poisson ($\nu = 1$), geometric ($\nu = 0$, $\lambda < 1$) and Bernoulli ($\nu \to \infty$ with probability $\lambda/(1+\lambda)$).

One of the major limitations of CMP distributions is that it is not directly parametrized via the mean as it does not have closed-form expression for its moments in terms of the parameters $\lambda$ and $\nu$. For the first two moments, approximation can be obtained as 
$$
\begin{aligned}
E(Y)  &\approx \lambda^{\frac{1}{\nu}}-\frac{\nu-1}{2\nu}\quad  \text{and} \quad Var(Y) \approx \frac{1}{\nu}E(Y),
\end{aligned}
$$
and they can be particularly accurate for $\nu\leq 1$ or $\lambda>10^{\nu}$ (see @Shmueli2005). If $\nu < 1$, CMP is overdispersed. In reverse, CMP is underdispersed when $\nu>1$. 

## Conway-Maxwell-Poisson Generalized Linear Models {#glm}
As CMP is one of a few distributions that can handle both under- and over-dispersion, the aim is to extend the GLM formulation to the CMP case so that one can model the relationship between $Y$ and the predictors $X$. Given a set of covariates $X \in R^q$, @Sellers2010 proposed a GLM for count response $Y$ that can be specified via
$$
Y|X ∼ CMP(\lambda,\nu), \quad \text{s.t.} \quad \log\lambda = X^{\top}\beta
$$ 
where $\beta \in R^q$ is a vector of regression coefficients. This model however does not provide a closed form relationship between $E(Y)$ and the linear predictor, making it incompatible with other commonly used log-linear model.

As it is more convenient and interpretable to model the mean $\mu = E(Y)>0$ of the distribution directly, @Huang2017b proposed to parametrize the CMP distribution via the mean:
$$
P(Y = y|\mu, \nu) = \frac{\lambda(\mu,\nu)^{y}}{(y!)^{\nu}}\frac{1}{Z(\lambda(\mu,\nu),\nu)}, \quad y = 0,1,2,\ldots,
$$
where the rate $\lambda(\mu,\nu)$ is defined as the solution to the mean constraint:
$$
 \mu= \sum^{\infty}_{y=0} y\frac{\lambda^y}{(y!)^{\nu}}\frac{1}{Z(\lambda,\nu)}.
$$ 
We shall denote this as CMP$_{\mu}(\mu, \nu)$ distribution to distinguish it from the original/standard one.

A GLM that based on CMP$_{\mu}$ can then be specified via 
$$
Y|X ∼ CMP_{\mu}(\mu(X^{\top}\beta),\nu), 
$$ 
where
$$
E(Y|X) = \mu(X^{\top}\beta) = \exp(X^{\top}\beta).
$$
Note that GLM that based on CMP$_{\mu}$ is a genuine GLM, so all the familiar key features of GLMs (e.g., McCullagh & Nelder, 1989, Chapter 2) are retained.

The mean-dispersion specification makes CMP$_{\mu}$ directly comparable
and compatible other commonly used log-linear regression models for counts. In particular, the mean $\mu = \exp(X^{\top}\beta)$ is functionally independent of the dispersion parameter $\nu$, making it similar in structure to the familiar Negative Binomial regression model for overdispersed counts. 

The model can also be extended so that $\nu$ itself is modelled via a regression with a log-link, i.e.
$$
\nu = \exp(\tilde{X}^{\top}\gamma),
$$
where $\tilde{X}$ is some covariates. 

## The `mpcmp` package

The main modelling function in our `mpcmp` package is `glm.cmp()`. The optimisation is done using Fisher Scoring updates to take advantage of the fact the CMP$_{\mu}$ belongs to the exponential family. Notice that this is actually a constrained optimisation problem as we have to maintain mean constraints at all times which makes the implementation is bit more challenging. 

The package implements similar methods to those related to `glm` objects. If you used `glm()` previously, you should feel right at home. Once a fitted model object has been obtained, there are assessor functions available to extract the coefficients (`coef()`, or its alias `coefficients()`), the fitted values (`fitted()` or its alias `fitted.values()`), the residuals (`residuals()` or its alias `resid()`), the model frame (`model.frame()`), the number of observations (nobs()), the log-likelihood (`logLik()`), and the AIC (`AIC()`). 

You can also use `plot()` or `gg_plot()` to obtain diagnostic plots of the fitted model.  

Let's go through some examples to show you what our package can do! 

## Constant Dispersion Example: `attendance`

The `attendance` dataset (originally from [https://stats.idre.ucla.edu/r/dae/negative-binomial-regression/](https://stats.idre.ucla.edu/stat/stata/dae/nb_data.dta)) examines the relationship between the number of days absent from school and the gender, maths score and academic program of 314 students from two urban high schools. 

```{r, message=FALSE}
library(mpcmp)
data(attendance)
library(ggplot2)
ggplot(attendance, aes(daysabs, fill = prog)) + geom_histogram(binwidth = 1) + 
  facet_grid(prog ~ ., margins = TRUE, scales = "free")
```

It is obvious that there are some overdispersion in this dataset. We can use `glm.cmp()` to fit the mean-parametrized CMP model to this data set. 

```{r}
M.attendance <- glm.cmp(daysabs~ gender+math+prog, data=attendance)
summary(M.attendance)
```

```{r, echo=FALSE}
beta <- abs(round(coef(M.attendance)[5], 3))
mul_factor <- round(exp(beta),1)
```

As `mpcmp` is directly comparable and compatible with other commonly used log-linear regression models for counts, interpreting parameters is straight forward. Our model estimates that students in the General program (the reference level) are expected to miss exp(+`r beta`) = `r mul_factor` times more days of school compared to students in the Vocational program.

One of the key features of the `mpcmp` package is that it provides a range of diagnostic plots.
```{r}
gg_plot(M.attendance)
```
Please refer to `?gg_plot` to see what plots are available. 

We also implemented a bunch of commonly used methods for "cmp" objects: 
```{r}
methods(class = "cmp")
```

## Varying Dispersion Example: `sitophilus`

Ribeiro et al. (2013) carried out an experiment to assess the bioactivity of extracts from different parts (seeds, leaves and branches) of Annona mucosa (Annonaceae) to control Sitophilus zeamaus (Coleoptera: Curculionidae), a major pest of stored maize/corn in Brazil.

In this experiment:

- 10g of corn and 20 animals adults were placed in each Petri dish.
- Extracts prepared with different parts of mucosa or just water (control) were completely
randomised with 10 replicates.
- The numbers of emerged insects (progeny) after 60 days were recorded and some descriptive statistics can be found below.
```{r, message = FALSE}
data(sitophilus)
with(sitophilus, tapply(ninsect, factor(extract), mean))
with(sitophilus, tapply(ninsect, factor(extract), var))
```

It appears that the treatment may have some impact on both the mean and the variance of the number of progeny. Recall that non-constant variance is a given in a GLM, non-constant variances do not necessarily means varying dispersion. Nonetheless, we will try to use the treatment to explain the dispersion in the data set.

```{r}
data(sitophilus)
M.sit <- glm.cmp(formula = ninsect ~ extract, formula_nu = ~ extract, data = sitophilus)
summary(M.sit)
```

From the model summary, we can see that there is not much evidence to suggest the dispersions are varying across treatment groups. We can also formally test whether a constant dispersion model is sufficient here using a likelihood ratio test as the two models are nested:
```{r}
M.sit2 <- update(M.sit, formula_nu = NULL)
cmplrtest(M.sit, M.sit2)
```
As a result, our final model is 
```{r}
summary(M.sit2)
```




## Diagnostics 

### Likelihood ratio test 

### Probability integral transformation 

### Plots 

## Examples 

There are three example datasets currently included in the `mpcmp` package which cover over- and under-dispersed counts. Sample analyses for these datsets are provided in either the help page for the datasets or for the `glm.cmp()` function. 


### Underdispersed takeover bids data 

### Underdispersed Cotton bolls data

## Other packages for fitting Conway-Maxwell Poisson Model

There are other `R` packages to deal with CMP models and they all help the writing and construction of this package.

- `compoisson`: Routines for density and moments of the COM-Poisson distribution under original parametrization by @R-compoisson
- `CompGLM`: Fit COM-Poisson models under original parametrization (includes dispersion modelling) by @R-CompGLM.
- `COMPoissonReg`: Fit COM-Poisson models under original parametrization (includes zero-inflation and dispersion modelling) by @R-COMPoissonReg. 
- `cmpreg`: Fit Mean-type parametrized COM-Poisson models (includes dispersion modelling) by @R-cmpreg. The authors purposed to regressed on the approximated mean. 
- `DGLMExtPois`: Fit mean-parametrized COM-Poisson model (includes dispersion modelling) using `nloptr` by @R-DGLMExtPois. 
- `glmmTMB`: Fit (among other) COM-Poisson models under a different mean-parametrization (includes zero-inflation, dispersion modelling and random effects) by @R-glmmTMB. 

## References

